{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>SRT/VTT Edit</h2>
    <form id="uploadForm" action="{{ url_for('srt.srt_edit') }}" method="post" onsubmit="uploadFile(event)">
        <label for="file">Select SRT/VTT File:</label>
        <select name="file" style="width: 100%;">
            <option value="" selected>-- Select SRT File --</option>
            {% for srt_file in srt_files %}
            <option value="{{ srt_file }}">{{ srt_file }}</option>
            {% endfor %}
        </select>
        <label for="video">Select Video File (optional):</label>
        <select name="video" style="width: 100%;">
            <option value="" selected>-- Select Video File --</option>
            {% for video_file in video_files %}
            <option value="{{ video_file }}">{{ video_file }}</option>
            {% endfor %}
        </select>
        <button type="submit">Upload</button>
        <div class="progress-bar">
            <progress id="progressBar" value="0" max="100"></progress>
        </div>
    </form>
    <div id="editorContainer" class="editor-container" style="display: none; margin-top: 20px;">
        <div class="split-container">
            <div class="video-column">
                <div class="video-container">
                    <video id="videoPlayer" controls>
                        <source id="videoSource" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>
            <div class="editor-column">
                <form id="editForm" action="{{ url_for('srt.srt_edit') }}" method="post">
                    <input type="hidden" name="file_path" id="filePath">
                    <textarea name="file_content" id="fileContent" rows="20" cols="50"></textarea>
                    <div class="save-container">
                        <label for="custom_name">Save As:</label>
                        <input type="text" name="custom_name" placeholder="Enter custom file name">
                        <button type="submit">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        function uploadFile(event) {
            event.preventDefault();
            var form = document.getElementById('uploadForm');
            var progressBar = document.getElementById('progressBar');
            var formData = new FormData(form);
            var xhr = new XMLHttpRequest();
            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    var percentComplete = (event.loaded / event.total) * 100;
                    progressBar.value = percentComplete;
                }
            };
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    if (response.file_content) {
                        document.getElementById('filePath').value = response.file_path;
                        document.getElementById('fileContent').value = response.file_content;
                        document.getElementById('editorContainer').style.display = 'block';
                    }
                    if (response.video_path) {
                        var videoPlayer = document.getElementById('videoPlayer');
                        var videoSource = document.getElementById('videoSource');
                        videoSource.src = response.video_path;
                        videoPlayer.load();
                    }
                } else {
                    alert('Error uploading file. Please try again.');
                }
            };
            xhr.open('POST', form.action, true);
            xhr.send(formData);
        }
    </script>
    {% for message in get_flashed_messages() %}
    <p>{{ message }}</p>
    {% endfor %}
</div>
{% endblock %}
